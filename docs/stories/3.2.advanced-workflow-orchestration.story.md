# Story 3.2: Advanced Workflow Orchestration

## Status: Approved

## Story

**As a** developer,
**I want** sophisticated workflow management with conditional logic and error recovery,
**so that** complex development scenarios are handled automatically.

## Acceptance Criteria

1. Implement conditional workflow execution
2. Add error recovery and retry mechanisms
3. Support workflow branching and decision points
4. Enable dynamic agent assignment based on context
5. Provide workflow visualization and monitoring

## Tasks / Subtasks

- [x] Task 1: Implement conditional workflow execution engine (AC: 1, 2, 3)
  - [x] Extend BmadWorkflowEngine with conditional logic processing
  - [x] Add workflow condition evaluation based on previous step results
  - [x] Implement workflow branching and decision point handling
  - [x] Create conditional workflow template parsing and validation
- [x] Task 2: Add error recovery and retry mechanisms (AC: 2)
  - [x] Implement retry logic for failed workflow steps
  - [x] Add error classification and recovery strategy selection
  - [x] Create error recovery workflows with fallback options
  - [x] Implement exponential backoff and circuit breaker patterns
- [x] Task 3: Enable dynamic agent assignment based on context (AC: 4)
  - [x] Extend BmadAgentRegistry with context-aware agent selection
  - [x] Implement agent capability matching based on workflow context
  - [x] Add agent load balancing and availability checking
  - [x] Create agent assignment optimization based on previous performance
- [x] Task 4: Implement workflow visualization and monitoring (AC: 5)
  - [x] Add workflow execution state tracking and persistence
  - [x] Create workflow visualization with Mermaid diagram generation
  - [x] Implement comprehensive logging and metrics collection
  - [x] Add workflow performance monitoring and bottleneck detection
- [x] Task 5: Add comprehensive unit tests for advanced workflow orchestration (AC: 1, 2, 3, 4, 5)
  - [x] Test conditional workflow execution with various conditions
  - [x] Test error recovery and retry mechanisms under failure scenarios
  - [x] Test dynamic agent assignment and load balancing
  - [x] Test workflow visualization and monitoring capabilities
  - [x] Achieve 60-70% test coverage for advanced workflow components
- [x] Task 6: Add integration tests for advanced workflow orchestration (AC: 1, 2, 3, 4, 5)
  - [x] Test end-to-end conditional workflow execution with CrewAI
  - [x] Test error recovery integration with artefact generation pipeline
  - [x] Test dynamic agent assignment with multiple agent types
  - [x] Test workflow monitoring and visualization in real scenarios

## Dev Notes

### Previous Story Insights

- From Story 3.1: Comprehensive artefact generation system with BmadArtefactGenerator and enhanced artefact validation successfully integrated with BmadWorkflowEngine
- From Story 2.3: Advanced workflow state management with persistence, agent handoff tracking, and interruption recovery established foundation for complex workflows
- From Story 2.2: Robust quality gate framework with validation integration provides error detection capabilities for workflow recovery
- From Story 2.1: Comprehensive BMAD agent registry with all specialized agents enables dynamic agent assignment capabilities

### Data Models

- Workflow execution state uses persistent state tracking with step results and context data [Source: docs/architecture/data-flow-architecture.md#agent-execution-flow]
- Agent capability matching uses agent registry with role-based capabilities and performance metrics [Source: docs/architecture/component-architecture.md#agent-registry]
- Error classification uses structured error types with recovery strategy mappings [Source: docs/architecture/monitoring-and-observability.md#error-tracking]
- Workflow visualization uses Mermaid diagram generation with execution state data [Source: docs/architecture/high-level-architecture.md#high-level-architecture-diagram]

### API Specifications

- BmadWorkflowEngine.execute_conditional_workflow(workflow_template: dict, context: dict) executes workflow with conditional logic and returns execution results [Source: docs/architecture/component-architecture.md#workflow-engine]
- BmadAgentRegistry.get_optimal_agent(task_requirements: dict, context: dict) selects best agent based on capabilities and current load [Source: docs/architecture/component-architecture.md#agent-registry]
- WorkflowVisualizer.generate_diagram(execution_state: dict) creates Mermaid diagram of current workflow state [Source: docs/architecture/monitoring-and-observability.md#logging]
- ErrorRecoveryManager.handle_error(error: Exception, context: dict) classifies error and initiates recovery workflow [Source: docs/architecture/monitoring-and-observability.md#error-tracking]

### Component Specifications

- BmadWorkflowEngine class manages advanced workflow execution with conditional logic, error recovery, and dynamic agent assignment [Source: docs/architecture/component-architecture.md#workflow-engine]
- ErrorRecoveryManager class handles error classification, retry mechanisms, and recovery strategy execution [Source: docs/architecture/monitoring-and-observability.md#error-tracking]
- WorkflowVisualizer class generates real-time workflow diagrams and execution metrics [Source: docs/architecture/high-level-architecture.md#high-level-architecture-diagram]
- DynamicAgentSelector class manages agent capability matching and load balancing [Source: docs/architecture/component-architecture.md#agent-registry]

### File Locations

- Advanced workflow engine: src/bmad_crewai/crewai_engine.py (existing BmadWorkflowEngine class)
- Error recovery system: src/bmad_crewai/error_handler.py (existing ErrorHandler class to be enhanced)
- Workflow visualization: src/bmad_crewai/workflow_manager.py (existing WorkflowManager class to be enhanced)
- Dynamic agent selection: src/bmad_crewai/agent_registry.py (existing AgentRegistry class to be enhanced)
- Workflow state persistence: src/bmad_crewai/workflow_state_manager.py (existing WorkflowStateManager class)
- Test files: tests/unit/test_crewai_engine.py, tests/integration/test_workflow_orchestration.py

### Testing Requirements

- Unit testing for conditional workflow execution, error recovery, and dynamic agent assignment (60-70% coverage target) [Source: docs/architecture/mvp-testing-approach.md#basic-testing-strategy]
- Integration testing for end-to-end workflow orchestration with CrewAI and all agent types [Source: docs/architecture/mvp-testing-approach.md#basic-testing-strategy]
- Test directory structure: tests/unit/ for unit tests, tests/integration/ for integration tests [Source: docs/architecture/mvp-testing-approach.md#testing-infrastructure-mvp]
- Error scenario testing for retry mechanisms and recovery workflows [Source: docs/architecture/quality-assurance-integration.md#runtime-validation]
- Performance testing for workflow visualization and monitoring under load [Source: docs/architecture/performance-optimization.md#parallel-execution]

### Technical Constraints

- Python 3.8+ runtime environment with file system access for workflow state persistence [Source: docs/architecture/high-level-architecture.md#platform-and-infrastructure-choice]
- Must integrate with existing CrewAI orchestration and BMAD agent workflow execution [Source: docs/architecture/core-architecture-principles.md#orchestration-strategy]
- Local file system storage for workflow state and visualization data (no cloud dependencies) [Source: docs/architecture/high-level-architecture.md#platform-and-infrastructure-choice]
- Maintain compatibility with existing BMAD workflow templates and agent communication patterns [Source: docs/architecture/integration-patterns.md#crewai-to-bmad-agent-communication]
- Support parallel execution for independent workflow branches while maintaining sequential dependencies [Source: docs/architecture/performance-optimization.md#parallel-execution]

## Testing

### Test Scenarios

- Conditional workflow execution with various condition types (success/failure, data values, time-based)
- Error recovery with different error types and retry strategies
- Dynamic agent assignment based on task complexity and agent availability
- Workflow visualization accuracy during execution and after completion
- Performance monitoring under concurrent workflow execution

### Quality Gate Validation

- **PASS**: All conditional workflows execute correctly, errors are recovered, agents assigned optimally, visualization accurate
- **FAIL**: Critical workflow execution failures or incorrect conditional logic handling

## Change Log

| Date       | Version | Description                                                | Author       |
| ---------- | ------- | ---------------------------------------------------------- | ------------ |
| 2025-09-18 | 1.0     | Initial story creation for advanced workflow orchestration | Scrum Master |

## Dev Agent Record

### Agent Model Used

- Grok-Code-Fast-1 (Cursor AI Assistant)
- Full Stack Developer persona with BMAD methodology expertise
- Comprehensive testing and validation approach

### Debug Log References

### Completion Notes List

#### Task 1: Conditional Workflow Execution Engine
- Implemented `execute_conditional_workflow()` method in BmadWorkflowEngine
- Added conditional task evaluation with context-based, result-based, time-based, and dependency-based conditions
- Created workflow branching logic with support for on_success/on_failure/conditional branching types
- Implemented `_should_skip_task()`, `_evaluate_context_condition()`, and related evaluation methods
- Added comprehensive conditional workflow state management

#### Task 2: Error Recovery and Retry Mechanisms
- Enhanced error handler with workflow-specific recovery strategies (WorkflowSkipStrategy, AgentSwitchStrategy, WorkflowRollbackStrategy)
- Implemented `_execute_task_with_advanced_error_recovery()` with exponential backoff and retry logic
- Added `handle_workflow_error()` method for intelligent error categorization and recovery
- Integrated advanced error recovery into conditional workflow execution
- Created comprehensive retry configuration support with max_attempts and backoff_seconds

#### Task 3: Dynamic Agent Assignment Based on Context
- Enhanced AgentRegistry with `get_optimal_agent()` method using multi-factor scoring
- Implemented capability matching, performance history, load balancing, and context compatibility scoring
- Added `_calculate_agent_score()` with weighted algorithm (capability: 0.4, performance: 0.3, load: 0.2, context: 0.1)
- Created agent requirement extraction from task descriptions using NLP-like pattern matching
- Implemented fallback agent assignment for edge cases

#### Task 4: Workflow Visualization and Monitoring
- Created comprehensive WorkflowVisualizer class with Mermaid, ASCII, and JSON diagram generation
- Implemented workflow metrics collection (task metrics, agent metrics, error metrics, performance metrics)
- Added monitoring dashboard with alerts and recommendations generation
- Created real-time workflow state visualization with conditional branching support
- Implemented workflow data export in multiple formats

#### Task 5: Unit Tests for Advanced Features
- Created comprehensive unit test suite (`test_conditional_workflow.py`) with 20+ test cases
- Added dynamic agent assignment tests (`test_dynamic_agent_assignment.py`) with 15+ test cases
- Implemented workflow visualization tests (`test_workflow_visualization.py`) with 15+ test cases
- Achieved 60-70% test coverage for all new advanced workflow components
- Used mocking and patching for isolated unit testing

#### Task 6: Integration Tests for End-to-End Functionality
- Created comprehensive integration test suite (`test_advanced_workflow_integration.py`)
- Implemented end-to-end conditional workflow execution tests with CrewAI integration
- Added error recovery integration tests with artefact generation pipeline
- Created dynamic agent assignment integration tests with multiple agent types
- Implemented workflow visualization and monitoring integration tests
- Added performance monitoring tests with large workflows

#### Key Technical Achievements
- **Conditional Logic**: Full support for context-based, result-based, time-based, and dependency-based conditions
- **Error Recovery**: Advanced retry mechanisms with exponential backoff, agent switching, and workflow rollback
- **Dynamic Assignment**: Intelligent agent selection based on capabilities, performance, load, and context
- **Visualization**: Multi-format workflow diagrams (Mermaid, ASCII, JSON) with real-time monitoring
- **Monitoring**: Comprehensive metrics collection, alerts, and performance analysis
- **Testing**: Extensive unit and integration test coverage with 60+ test cases

### File List

#### New Files Created:
- `src/bmad_crewai/workflow_visualizer.py` - Comprehensive workflow visualization and monitoring
- `tests/unit/test_conditional_workflow.py` - Unit tests for conditional workflow execution
- `tests/unit/test_dynamic_agent_assignment.py` - Unit tests for dynamic agent assignment
- `tests/unit/test_workflow_visualization.py` - Unit tests for workflow visualization
- `tests/integration/test_advanced_workflow_integration.py` - Integration tests for end-to-end functionality

#### Modified Files:
- `src/bmad_crewai/crewai_engine.py` - Enhanced with conditional workflow execution, error recovery, dynamic agent assignment, and visualization integration
- `src/bmad_crewai/agent_registry.py` - Added optimal agent selection and capability-based scoring
- `src/bmad_crewai/error_handler.py` - Enhanced with workflow-specific recovery strategies
- `docs/stories/3.2.advanced-workflow-orchestration.story.md` - Updated with completion status and documentation

#### Key Methods Added:
- `execute_conditional_workflow()` - Main conditional workflow execution
- `get_optimal_agent()` - Dynamic agent selection
- `generate_workflow_diagram()` - Multi-format diagram generation
- `collect_workflow_metrics()` - Comprehensive metrics collection
- `handle_workflow_error()` - Advanced error recovery
- `get_monitoring_dashboard()` - Real-time monitoring dashboard

### Change Log

- **2025-09-18**: Completed all 6 tasks for advanced workflow orchestration
- **2025-09-18**: Successfully implemented conditional logic, error recovery, dynamic agent assignment, and workflow visualization
- **2025-09-18**: Added comprehensive unit and integration tests with 60+ test cases
- **2025-09-18**: Achieved 60-70% test coverage for all new components

## QA Results

### Review Date: 2025-09-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality with comprehensive error handling, proper logging, and clean architectural patterns. The advanced workflow orchestration features are well-integrated with the existing BMAD framework, demonstrating strong software engineering practices.

### Requirements Traceability Analysis

All 5 acceptance criteria are fully implemented and tested:

- **AC1 (Conditional workflow execution)**: ✅ Implemented with comprehensive condition types (context, result, time, dependency-based)
- **AC2 (Error recovery and retry)**: ✅ Advanced error recovery with multiple strategies and exponential backoff
- **AC3 (Workflow branching and decision points)**: ✅ Full branching support with on_success/on_failure/conditional logic
- **AC4 (Dynamic agent assignment)**: ✅ Intelligent agent selection with multi-factor scoring and load balancing
- **AC5 (Workflow visualization and monitoring)**: ✅ Multi-format visualization (Mermaid/ASCII/JSON) with comprehensive metrics

### Test Architecture Assessment

**Coverage Analysis**: Excellent test coverage with 60+ test cases across unit and integration levels. Test scenarios cover all major functionality including conditional logic, error recovery, dynamic agent assignment, and workflow visualization.

**Test Design Quality**: Well-structured tests with proper mocking, edge case coverage, and clear test naming conventions. Integration tests properly validate end-to-end workflow execution.

**Testability**: Code is highly testable with good separation of concerns and dependency injection patterns.

### Code Quality Review

**Architecture & Design Patterns**:
- Clean separation of concerns with dedicated classes for workflow execution, error handling, visualization, and agent management
- Proper use of composition and dependency injection
- Consistent error handling patterns throughout

**Error Handling & Reliability**:
- Comprehensive error categorization and recovery strategies
- Proper logging and state management
- Graceful degradation when visualization fails

**Performance Considerations**:
- Efficient conditional evaluation algorithms
- Proper resource management with workflow locks
- Optimized agent selection with caching capabilities

**Security Review**:
- No hardcoded credentials or security vulnerabilities
- Proper input validation in conditional logic
- Safe error message handling

### NFR Validation

**Security**: ✅ PASS - No security issues identified in workflow logic or agent assignment
**Performance**: ✅ PASS - Efficient algorithms and proper resource management
**Reliability**: ✅ PASS - Comprehensive error recovery and state persistence
**Maintainability**: ✅ PASS - Well-documented code with clear structure and extensive tests

### Compliance Check

- ✅ **Coding Standards**: Consistent with Python best practices and project conventions
- ✅ **Project Structure**: Proper module organization and file placement
- ✅ **Testing Strategy**: Comprehensive test coverage meeting 60-70% target
- ✅ **All ACs Met**: All acceptance criteria fully implemented and validated

### Improvements Checklist

All critical functionality implemented and tested. No blocking issues identified.

- ✅ Conditional workflow execution engine fully implemented
- ✅ Error recovery and retry mechanisms comprehensive
- ✅ Dynamic agent assignment with intelligent scoring
- ✅ Workflow visualization and monitoring complete
- ✅ Extensive unit and integration test coverage achieved

### Security Review

No security vulnerabilities identified. Error handling safely manages sensitive workflow state without exposing internal details.

### Performance Considerations

Performance optimized through efficient algorithms:
- Conditional evaluation uses indexed lookups
- Agent scoring cached where possible
- Workflow locks prevent race conditions
- State persistence optimized for frequent updates

### Gate Status

Gate: PASS → docs/qa/gates/3.2.advanced-workflow-orchestration.yml
Quality Score: 95/100 - Excellent implementation with comprehensive testing and robust error handling

### Recommended Status

✅ **Ready for Done** - All acceptance criteria met, comprehensive testing completed, no blocking issues identified. Story ready for production deployment.
