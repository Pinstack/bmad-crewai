# Story 4.1: LLM Assist Scaffolding + Artefact Detection Fallback

## Status: Draft

## Story

**As a** developer,
**I want** an optional, config-gated LLM assist to help classify artefact type only when rules are unsure,
**so that** our strict, deterministic behavior remains the default while reducing false flags in hard language cases.

## Acceptance Criteria

1. Config-gated assist (default OFF): With assist disabled, behaviour is bit-for-bit unchanged on existing tests.
2. Scope limited to artefact detection: Fallback triggers only when rule-based detection returns `unknown` (no other gates/policies change).
3. Strict contract: The assist returns a strict JSON schema `{artefact_type, confidence, rationale}`; unknown/low-confidence falls back to rules.
4. Confidence/timeout/caching: Configurable confidence threshold and timeout; simple content-hash cache avoids repeated calls in a run.
5. Audit trail: When assist is used, log decision details (content hash, classification, confidence, rationale) to the developer debug log.

## Tasks / Subtasks

- [ ] Introduce assist configuration (default OFF)
  - [ ] Add `bmad.llm_assist.enabled` (bool, default `false`) and `bmad.llm_assist.confidence_threshold` (float), `bmad.llm_assist.timeout_seconds` (int)
  - [ ] Expose getters via `ConfigManager` for use in detection logic
- [ ] Implement `LLMClassifier` scaffold (no provider lock-in)
  - [ ] Location: `src/bmad_crewai/assist/llm_classifier.py` (new module)
  - [ ] Public API: `classify_artefact(content: str) -> dict` → `{artefact_type, confidence, rationale}`
  - [ ] Enforce timeout and strict schema; add in-process cache keyed by content hash
  - [ ] Provider-agnostic: use existing model selection patterns; support mockable interface for tests
- [ ] Wire fallback in artefact detection
  - [ ] Update `ChecklistExecutor.detect_artefact_type(...)` so that when the rules return `unknown` and assist is enabled, call `LLMClassifier`
  - [ ] Apply confidence gate: if `confidence < threshold`, return `unknown` (keep rule-based result)
  - [ ] Write audit log (content hash, predicted type, confidence, rationale) to dev debug log
- [ ] Unit tests (assist disabled and enabled)
  - [ ] Disabled path: verify bit-for-bit unchanged classification on representative samples
  - [ ] Enabled path: mock classifier to return (a) high-confidence classification → adopted, (b) low-confidence → fallback to `unknown`
  - [ ] Cache/timeout behaviour verified via mocks (no network required)
- [ ] Documentation updates
  - [ ] Briefly document the feature and config in `docs/architecture/component-architecture.md` under a small “LLM Assist (Optional)” subsection
  - [ ] Add operator note: assist is optional, defaults off, and never relaxes thresholds/policy

## Dev Notes

### Relevant Code and Integration Points

- Artefact detection rules (hook point): `src/bmad_crewai/checklist_executor.py` → `detect_artefact_type(artefact_content: str) -> str`
- Configuration manager used by CLI/runtime: `src/bmad_crewai/config.py` (`ConfigManager`, `BMADConfig`)
- Developer debug log path from core config: `.bmad-core/core-config.yaml` → `devDebugLog: .ai/debug-log.md`
- AI model selection and fallback context: `docs/architecture.md#AI Model Configuration`

### Constraints & Guardrails

- Default OFF: No behaviour change with assist disabled (bit-for-bit on existing tests)
- Scope: Only artefact detection fallback in this story (acceptance/test-type fallbacks come later)
- Determinism: PASS/CONCERNS/FAIL thresholds and policies remain unchanged
- Strict schema + fail-safe: On any schema/timeout/confidence failure, fall back to rule-based detection

### Suggested Interfaces

```python
# src/bmad_crewai/assist/llm_classifier.py
class LLMClassifier:
    def __init__(self, config_manager):
        ...  # read enabled, threshold, timeout

    def classify_artefact(self, content: str) -> dict:
        """
        Returns: {
          'artefact_type': 'story'|'epic'|'architecture'|'prd'|'unknown',
          'confidence': float,   # 0.0..1.0
          'rationale': str
        }
        """
        ...
```

### Testing Standards

- Unit tests live under `tests/unit/` mirroring module structure
- Mock external calls; no network in tests
- Validate logging lines exist when assist is used

## Testing

- Disabled: verify existing artefact samples classify identically before/after change
- Enabled: simulate ambiguous content; assert high-confidence adoption and low-confidence fallback
- Performance: ensure timeout is enforced via mock clock or stub

## Change Log

| Date       | Version | Description                                           | Author |
|------------|---------|-------------------------------------------------------|--------|
| 2025-09-20 | 0.1     | Initial draft for LLM assist scaffolding and fallback | SM     |

## Dev Agent Record

### Agent Model Used

<to be filled by dev>

### Debug Log References

<to be filled by dev>

### Completion Notes List

<to be filled by dev>

### File List

<to be filled by dev>

## QA Results

<to be filled by QA>

