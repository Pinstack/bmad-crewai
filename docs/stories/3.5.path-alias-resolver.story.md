# Story 3.5: Path Alias Resolver (Course-Correct)

## Status: Done

## Story

**As a** product owner,
**I want** legacy BMAD file names (e.g., brownfield-prd.md) to resolve to canonical paths (docs/prd.md, docs/architecture.md),
**so that** links, quality checks, and tooling remain stable across documentation changes.

## Acceptance Criteria

1. Alias map supports at least: `docs/brownfield-prd.md → docs/prd.md`, `docs/brownfield-architecture.md → docs/architecture.md`.
2. Internal link validation treats aliases as valid targets.
3. Artefact writer resolves aliases when writing or checking files.
4. No default behavior change for canonical paths; all existing tests pass.
5. Guidance is emitted for missing canonical targets that match known aliases (operator migration note).

## Tasks / Subtasks

- [X] Implement a lightweight path alias resolver utility with a configurable map.
  - [X] Suggested location: `src/bmad_crewai/utils/path_alias.py`
  - [X] Public API: `resolve_path(path: str) -> str` and `is_alias(path: str) -> bool`
- [X] Integrate resolver into internal link validation.
  - [X] Modify `_validate_internal_references` in `src/bmad_crewai/quality_gate_manager.py:601` to resolve `link_target` via resolver before existence checks.
  - [X] When a link resolves from alias→canonical, record the normalized target in results.
- [X] Integrate resolver into artefact writer.
  - [X] Normalize input/output paths using resolver before file operations in `src/bmad_crewai/artefact_writer.py` (folder mapping and write/read helpers).
  - [X] Ensure canonical FOLDER_MAPPING remains authoritative; aliases are only for resolution, not for generation.
- [X] Add unit tests for alias resolution behavior.
  - [X] Tests for: canonical path (no change), known alias (maps to canonical), unknown path (unchanged), and missing canonical target (yields migration guidance).
  - [X] Tests for link validation using alias targets to avoid false "broken link".

## Dev Notes

### Context & Rationale

- Canonical artefact locations are defined and used by orchestration and writing flows [Source: `docs/architecture/component-architecture.md#artefact-writer`].
- Quality Gate Manager performs markdown link scanning and currently checks `os.path.exists` directly on `docs/...` targets [Source: `src/bmad_crewai/quality_gate_manager.py:601`].
- Introducing a central alias resolver prevents churn and CI instability when BMAD docs are renamed while preserving strict canonical paths as the source of truth [Source: `docs/epics/epic-4-llm-assist-and-canonical-path-stability.md`].

### Relevant Architecture Details

- Artefact Writer maps types to canonical destinations, including `prd`, `architecture`, `stories`, `qa_assessments`, `qa_gates`, and `epics` [Source: `docs/architecture/component-architecture.md#artefact-writer`].
- Repository uses a monorepo structure with a clear artefact layer under `docs/` [Source: `docs/architecture/high-level-architecture.md#repository-structure` and `docs/architecture/high-level-architecture.md#high-level-architecture-diagram`].

### Design

- Alias map (initial):
  - `docs/brownfield-prd.md` → `docs/prd.md`
  - `docs/brownfield-architecture.md` → `docs/architecture.md`
- Resolver utility:
  - `resolve_path(p)` returns canonical path if `p` is a known alias, else returns `p` unchanged.
  - `is_alias(p)` returns True if `p` is in the alias map.
- Integration points:
  - Link validation: resolve target before `os.path.exists` checks to eliminate false negatives. If alias resolves but canonical missing, add actionable message (guided migration) instead of a generic broken link [Source: `src/bmad_crewai/quality_gate_manager.py:601-612`].
  - Artefact Writer: normalize any inbound path parameter prior to file operations to maintain write/read consistency; do not generate alias-named files [Source: `src/bmad_crewai/artefact_writer.py` (FOLDER_MAPPING and write helpers)].

### File Locations

- New: `src/bmad_crewai/utils/path_alias.py` (resolver utility)
- Update: `src/bmad_crewai/quality_gate_manager.py` in `_validate_internal_references`
- Update: `src/bmad_crewai/artefact_writer.py` where paths are interpreted or validated

### Testing Requirements

- Follow MVP testing approach with unit tests focused on resolver and its integration points [Source: `docs/architecture/mvp-testing-approach.md#basic-testing-strategy`].
- Unit tests should cover:
  - Canonical-only paths remain unchanged and pass existing checks.
  - Known aliases resolve to canonicals; link validation does not flag them as broken.
  - Unknown paths unchanged; still flagged if missing.
  - Alias resolves to missing canonical: produce migration guidance message.
- Suggested test files: `tests/unit/test_path_alias.py`, extend `tests/unit/test_quality_gate_manager.py`, and `tests/unit/test_artefact_writer.py`.

## Testing

- Unit tests for alias resolver and integrations as above.
- Ensure no regressions: with resolver present and no aliases used, behavior and outputs remain identical (bit-for-bit) to current tests.

## Dev Agent Record

### Agent Model Used

James (Full Stack Developer) - Expert Senior Software Engineer & Implementation Specialist

### Completion Notes

- Successfully implemented a lightweight path alias resolver utility with configurable mapping
- Integrated resolver into internal link validation with migration guidance for missing canonicals
- Integrated resolver into artefact writer for path normalization while preserving FOLDER_MAPPING authority
- Created comprehensive unit tests covering all resolver behaviors and integration points
- All acceptance criteria met: alias resolution, link validation stability, artefact writer integration, and migration guidance
- No regressions introduced - existing functionality preserved

### Debug Log References

- Unit tests executed and all 15 tests passed
- Integration tests confirmed resolver works with quality gate manager and artefact writer
- No import errors or runtime issues encountered

### File List

- New: `src/bmad_crewai/utils/path_alias.py` - Path alias resolver utility with configurable mapping and public API
- New: `tests/unit/test_path_alias.py` - Comprehensive unit tests for path alias resolver behavior and link validation integration
- Modified: `src/bmad_crewai/quality_gate_manager.py` - Integrated path alias resolver into internal link validation with migration guidance
- Modified: `src/bmad_crewai/artefact_writer.py` - Integrated path alias resolver into artefact read/write operations for path normalization

## QA Results

### Review Date: 2025-09-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality with clean, maintainable code. The path alias resolver follows SOLID principles with clear separation of concerns. Good use of global functions for convenience while maintaining testability through dependency injection. Comprehensive error handling and logging throughout.

### Refactoring Performed

None required - the implementation is well-architected and follows best practices.

### Compliance Check

- Coding Standards: ✅ Compliant - Clean, documented, follows Python conventions
- Project Structure: ✅ Compliant - Proper module organization and imports
- Testing Strategy: ✅ Compliant - Comprehensive unit and integration tests
- All ACs Met: ✅ All 5 acceptance criteria fully implemented and tested

### Improvements Checklist

- [X] Implementation follows architectural patterns from component-architecture.md
- [X] Proper error handling with fallback imports for test environments
- [X] Comprehensive test coverage including edge cases
- [X] Clear documentation and docstrings throughout
- [X] Integration points properly tested and validated

### Security Review

No security concerns identified. The utility performs pure path resolution with no external inputs or side effects that could introduce security vulnerabilities.

### Performance Considerations

Excellent performance characteristics:

- O(1) lookup time for alias resolution
- Minimal memory footprint with simple dictionary storage
- No blocking operations or I/O during resolution
- Negligible impact on existing system performance

### Files Modified During Review

None - implementation quality was sufficient without requiring changes.

### Gate Status

Gate: PASS → docs/qa/gates/3.5.path-alias-resolver.yml
Risk profile: docs/qa/assessments/3.5.path-alias-resolver-risk-20250920.md
NFR assessment: docs/qa/assessments/3.5.path-alias-resolver-nfr-20250920.md
Test design: docs/qa/assessments/3.5.path-alias-resolver-test-design-20250920.md
Trace: docs/qa/assessments/3.5.path-alias-resolver-trace-20250920.md

### Recommended Status

✅ Ready for Done
(Story owner decides final status)
